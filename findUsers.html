// findUsers.js - SIMPLIFIED VERSION
class FindUsers {
    constructor() {
        this.currentSearchTerm = '';
        this.isLoading = false;
        this.debounceTimer = null;
        this.init();
    }

    async init() {
        console.log('üîç FindUsers initializing...');
        await this.attachEventListeners();
        console.log('‚úÖ FindUsers ready');
    }

    async attachEventListeners() {
        document.addEventListener('input', (e) => {
            if (e.target.id === 'userSearchInput') {
                this.currentSearchTerm = e.target.value.trim();
                this.debouncedSearch();
            }
        });

        document.addEventListener('click', (event) => {
            const modal = document.getElementById('usersModal');
            if (event.target === modal) {
                this.hideUsers();
            }
        });
    }

    debouncedSearch() {
        clearTimeout(this.debounceTimer);
        this.debounceTimer = setTimeout(() => {
            this.loadUsers(this.currentSearchTerm);
        }, 300);
    }

    // =============== MODAL FUNCTIONS ===============
    
    async showUsers() {
        console.log('üë• Showing users modal...');
        
        const modal = document.getElementById('usersModal');
        const searchInput = document.getElementById('userSearchInput');
        
        modal.style.display = 'block';
        this.currentSearchTerm = '';
        
        if (searchInput) {
            searchInput.value = '';
            setTimeout(() => searchInput.focus(), 100);
        }
        
        await this.loadUsers();
    }

    hideUsers() {
        console.log('üëã Hiding users modal');
        const modal = document.getElementById('usersModal');
        modal.style.display = 'none';
        this.currentSearchTerm = '';
    }

    // =============== USER LOADING FUNCTIONS ===============
    
    async loadUsers(searchTerm = '') {
        if (this.isLoading) return;
        
        this.isLoading = true;
        const usersList = document.getElementById('usersList');
        
        try {
            usersList.innerHTML = '<div class="loading"><div class="spinner"></div>Loading users...</div>';
            
            console.log('üîç Querying Parse for users...');
            
            // SIMPLE DIRECT PARSE QUERY
            const result = await this.simpleParseQuery(searchTerm);
            
            if (result.success) {
                if (result.users && result.users.length > 0) {
                    await this.displayUsers(result.users);
                } else {
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-slash"></i>
                            <h3>No users found</h3>
                            <p>${searchTerm ? 'Try a different search' : 'No other users are registered yet'}</p>
                        </div>
                    `;
                }
            } else {
                usersList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error</h3>
                        <p>${result.error || 'Please try again'}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('‚ùå Error:', error);
            usersList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Connection Error</h3>
                    <p>Unable to load users. Please check your internet connection.</p>
                </div>
            `;
        } finally {
            this.isLoading = false;
        }
    }

    // SIMPLE PARSE QUERY - NO COMPLEX LOGIC
    async simpleParseQuery(searchTerm = '') {
        try {
            // Check if Parse is initialized
            if (typeof Parse === 'undefined') {
                throw new Error('Parse SDK not loaded');
            }
            
            if (!Parse.User.current()) {
                throw new Error('Not logged in');
            }
            
            console.log('Current user:', Parse.User.current().id, Parse.User.current().get('username'));
            
            // Create simple query
            const User = Parse.Object.extend('User');
            const query = new Parse.Query(User);
            
            // Exclude current user
            const currentUser = Parse.User.current();
            query.notEqualTo('objectId', currentUser.id);
            
            // Simple search
            if (searchTerm && searchTerm.trim() !== '') {
                query.contains('username', searchTerm);
            }
            
            // Limit and sort
            query.limit(50);
            query.ascending('username');
            
            console.log('Executing query...');
            const results = await query.find();
            console.log(`Found ${results.length} users`);
            
            // Format results simply
            const users = results.map(user => {
                return {
                    id: user.id,
                    objectId: user.id,
                    username: user.get('username') || 'Unknown',
                    email: user.get('email') || '',
                    createdAt: user.createdAt
                };
            });
            
            return {
                success: true,
                users: users
            };
            
        } catch (error) {
            console.error('Parse query error:', error);
            return {
                success: false,
                error: error.message,
                code: error.code
            };
        }
    }

    async displayUsers(users) {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';
        
        // Get current user ID
        const currentUserId = Parse.User.current() ? Parse.User.current().id : null;
        
        users.forEach(user => {
            // Skip current user
            if (user.id === currentUserId) return;
            
            const userDiv = document.createElement('div');
            userDiv.className = 'user-result';
            
            const username = user.username || 'Unknown';
            const userId = user.id;
            
            userDiv.innerHTML = `
                <div class="user-result-avatar">
                    ${username[0].toUpperCase()}
                </div>
                <div class="user-result-info">
                    <div class="user-result-name">${this.escapeHTML(username)}</div>
                    <div class="user-result-status">
                        Not connected
                    </div>
                </div>
                <div class="user-result-actions">
                    <button class="user-action-btn add" onclick="findUsers.addContact('${userId}', '${this.escapeString(username)}')" title="Add Contact">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            `;
            
            usersList.appendChild(userDiv);
        });
    }

    // =============== ACTION FUNCTIONS ===============
    
    async addContact(userId, username) {
        console.log(`‚ûï Adding contact: ${username} (${userId})`);
        
        try {
            // Try Backend function first
            if (typeof Backend !== 'undefined' && typeof Backend.addContact === 'function') {
                showNotification('Sending contact request...', 'info', 2000);
                const result = await Backend.addContact(userId, username);
                
                if (result.success) {
                    showNotification(`Contact request sent to ${username}! üì§`, 'success');
                    await this.loadUsers(this.currentSearchTerm);
                } else {
                    showNotification(result.error || 'Failed to send request', 'error');
                }
            } else {
                // Fallback: Create contact directly
                showNotification(`Would add ${username} as contact`, 'info');
                
                // You can implement direct Parse contact creation here
                // For now, just refresh the list
                await this.loadUsers(this.currentSearchTerm);
            }
        } catch (error) {
            console.error('Add contact error:', error);
            showNotification('Failed to send contact request', 'error');
        }
    }

    startChat(userId, username) {
        console.log(`üí¨ Starting chat with: ${username} (${userId})`);
        this.hideUsers();
        
        if (typeof window.startChat === 'function') {
            window.startChat(userId, username);
        } else {
            showNotification(`Would start chat with ${username}`, 'info');
        }
    }

    // =============== UTILITY FUNCTIONS ===============
    
    escapeHTML(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    escapeString(str) {
        return str.replace(/'/g, "\\'").replace(/"/g, '\\"');
    }

    // Debug function
    testConnection() {
        console.log('üîß Testing connection...');
        console.log('Parse available:', typeof Parse !== 'undefined');
        console.log('Parse.User.current():', Parse.User.current());
        
        if (Parse.User.current()) {
            console.log('Current user ID:', Parse.User.current().id);
            console.log('Current username:', Parse.User.current().get('username'));
        }
        
        // Test query
        this.simpleParseQuery().then(result => {
            console.log('Test query result:', result);
        });
    }
}

// Create global instance
let findUsers;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    findUsers = new FindUsers();
    
    // Expose to global
    window.showUsers = () => findUsers.showUsers();
    window.hideUsers = () => findUsers.hideUsers();
    window.findUsers = findUsers; // For debugging
});

// Fallback functions
if (typeof window !== 'undefined') {
    window.showUsers = window.showUsers || function() {
        console.warn('FindUsers not ready');
    };
    window.hideUsers = window.hideUsers || function() {
        console.warn('FindUsers not ready');
    };
}
